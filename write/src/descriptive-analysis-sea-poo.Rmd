---
title: I-213 descriptive analysis
author:
- "[Phil Neff](https://github.com/philneff)"
date: 4 October, 2023
output:
    html_document:
        html_preview: true
        toc: true
        toc_depth: 3
        toc_float: true
        code_folding: hide
---

```{r import, message = FALSE, warning = FALSE}

pacman::p_load(tidyverse, lubridate, here, skimr, yaml, ggplot2, ggalt, gplots,
               sf, rnaturalearth, rnaturalearthdata, maps, tools, RColorBrewer
               )

inputfile <- here::here("write/input/uw-chr-i213-public.csv.gz")

i213 <- read_delim(
    inputfile, delim = "|", 
    col_types = cols(
        # .default                     = col_character(),
        source                       = col_character(),
        sex                          = col_character(),
        cmplxn                       = col_character(),
        country_of_citizenship       = col_factor(),
        year                         = col_double(),
        month                        = col_double(),
        day                          = col_double(),
        hour                         = col_double(),
        minute                       = col_double(),
        fy                           = col_double(),
        age                          = col_double(),
        accompanied_juvenile_flag    = col_double(),
        unaccompanied_juvenile_flag  = col_double(),
        custody_redetermination_flag = col_double()
))

```

```{r cleaning}

i213 <- i213 %>%
  mutate(across(where(is.character), ~ na_if(.,"")))

i213$date <- as.Date(i213$date)
i213$month <- as.Date(cut(i213$date, breaks='month'))

i213 <- i213 %>% 
  mutate(lawsuit = case_when(
           str_detect(installment, "2023") ~ 2,
            TRUE ~ 1))

i213$installment <- factor(i213$installment, levels = c("ICE 2020-05",
"ICE 2020-06",
"ICE 2020-07",
"ICE 2020-08",
"ICE 2020-09",
"ICE 2020-10",
"ICE 2020-11",
"ICE 2020-12",
"ICE 2021-01",
"ICE 2021-06",
"ICE 2023-Pts.1-2",
"ICE 2023-Pt.3",
"ICE 2023-Pt.4",
"ICE 2023-Pt.5",
"ICE 2023-Pt.6",
"ICE 2023-Pt.7",
"ICE 2023-Pt.8",
"ICE 2023-Pt.9",
"ICE 2023-Pt.10"))

good_values <- c("ALBINO",
                 "BLACK",
                 "DARK BROWN",
                 "DARK",
                 "FAIR",
                 "LIGHT BROWN",
                 "LIGHT",
                 "MEDIUM BROWN",
                 "MEDIUM",
                 "OLIVE",
                 "RUDDY",
                 "SALLOW",
                 "YELLOW")

i213 <- i213 %>% mutate(cmplxn = case_when(
         cmplxn %in% good_values ~ cmplxn,
         is.na(cmplxn) ~ NA_character_,
         TRUE ~ "OTHER"))

i213$office <- str_match(i213$location_code, "SEA|POO|BLW|SPW")

i213 <- i213 %>% 
  mutate(method_short = case_when(
           str_detect(method_location_apprehension, "PB") ~ "PB",
           str_detect(method_location_apprehension, "CFD") ~ "CFD",
           str_detect(method_location_apprehension, "CST") ~ "CST",
           str_detect(method_location_apprehension, "CLC") ~ "CLC",
           str_detect(method_location_apprehension, "NCA") ~ "NCA",
           str_detect(method_location_apprehension, "LEA") ~ "LEA",
           str_detect(method_location_apprehension, "OA") ~ "OA",
           str_detect(method_location_apprehension, "OTF") ~ "OTF",
           str_detect(method_location_apprehension, "TCB") ~ "TCB",
           str_detect(method_location_apprehension, "ISP") ~ "ISP",
           str_detect(method_location_apprehension, "REP") ~ "REP",
           str_detect(method_location_apprehension, "L") ~ "L",
           str_detect(method_location_apprehension, "O|0") ~ "O",
           is.na(method_location_apprehension) ~ NA_character_,
            TRUE ~ NA_character_),
         method_verbose = case_when(
           str_detect(method_location_apprehension, "PB") ~ "Patrol Border",
           str_detect(method_location_apprehension, "CFD") ~ "CAP Federal",
           str_detect(method_location_apprehension, "CST") ~ "CAP State",
           str_detect(method_location_apprehension, "CLC") ~ "CAP Local",
           str_detect(method_location_apprehension, "NCA") ~ "Non-Custodial Arrest",
           str_detect(method_location_apprehension, "LEA") ~ "Law Enforcement Assist",
           str_detect(method_location_apprehension, "OA") ~ "Other Agency",
           str_detect(method_location_apprehension, "OTF") ~ "Task Force",
           str_detect(method_location_apprehension, "TCB") ~ "Transportation Check",
           str_detect(method_location_apprehension, "ISP") ~ "Inspection",
           str_detect(method_location_apprehension, "REP") ~ "Reprocessed",
           str_detect(method_location_apprehension, "L") ~ "Located",
           str_detect(method_location_apprehension, "O|0") ~ "Other",
           is.na(method_location_apprehension) ~ NA_character_,
            TRUE ~ NA_character_),
         method_int_border = case_when(
           str_detect(method_location_apprehension, "PB") ~ "Border",
           str_detect(method_location_apprehension, "CFD") ~ "Interior",
           str_detect(method_location_apprehension, "CST") ~ "Interior",
           str_detect(method_location_apprehension, "CLC") ~ "Interior",
           str_detect(method_location_apprehension, "NCA") ~ "Interior",
           str_detect(method_location_apprehension, "LEA") ~ "Interior",
           str_detect(method_location_apprehension, "OA") ~ "Interior",
           str_detect(method_location_apprehension, "OTF") ~ "Interior",
           str_detect(method_location_apprehension, "TCB") ~ "Interior",
           str_detect(method_location_apprehension, "ISP") ~ "Border",
           str_detect(method_location_apprehension, "L") ~ "Interior",
           str_detect(method_location_apprehension, "REP") ~ "Other",
           str_detect(method_location_apprehension, "O|0") ~ "Other",
           is.na(method_location_apprehension) ~ NA_character_,
            TRUE ~ NA_character_))
```

# Descriptive analysis of UWCHR I-213 collection

## Analysis of SEA & POO sub-office records only

I-213 records from April 2020 through November 2021 (second lawsuit production) do not include any forms with location codes "BLW" or "SPW". Therefore in the following we restrict records to "SEA" and "POO" (Seattle and Portland sub-offices) only for more consistent comparison over time. Some sections of analysis which are only relevant to the full collection are struck from the following; interpretive text is also struck.

```{r lawsuit_office}

p1 <- i213 %>% 
  filter(source == 'ice') %>% 
  count(lawsuit, office) %>% 
  ggplot(aes(x = office, y=n, fill=as.factor(lawsuit))) +
  geom_col() +
  facet_wrap(~lawsuit) +
  labs(title = "I-213 form office code by lawsuit production")
  

p1

i213 <- i213 %>% 
  filter(office %in% c("SEA", "POO"))

```


## ICE record release installments

```{r installment_distribution, message = FALSE, warning = FALSE}

i213$date <- as.Date(i213$date)

data <- i213 %>%
  select(date, source, installment, lawsuit) %>%
  filter(date >= '2019-01-01',
         date <= '2021-12-31',
         source == 'ice')

data$month <- as.Date(cut(data$date, breaks='month'))

p1 <- data %>% ggplot(aes(x = month)) +
  geom_bar() +
  # scale_x_date(labels = scales::date_format("%b"), 
  #              breaks = "3 month") +
  facet_wrap(~installment) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "I-213 installment distribution")

p1

p2 <- data %>% ggplot(aes(x = month, fill=installment)) +
  geom_bar(width=10) +
  #scale_x_date(labels = scales::date_format("%b"), 
  #             breaks = "3 month") +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))  +
  labs(title = "I-213 installment distribution")

p2

p3 <- data %>% ggplot(aes(x = month, fill=as.factor(lawsuit))) +
  geom_bar(width=10) +
  #scale_x_date(labels = scales::date_format("%b"), 
  #             breaks = "3 month") +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "I-213 distribution by lawsuit production")

p3

```

## Demographics: Overview

Here we display tables for basic demographic characteristics for subjects of the ICE I-213 forms: ten most common "Country of Citizenship" values; "Age" and "Sex" breakdowns (excluding missing values); and "Complexion".

"Complexion" values are decoded following ["The Border's Long Shadow"](https://www.aclumich.org/en/publications/borders-long-shadow) (ACLU of Michigan, 2021).

```{r demographics, message = FALSE, warning = FALSE}

i213 %>% count(country_of_citizenship, sort=TRUE) %>% 
  mutate(pct = n/sum(n) * 100) %>% 
  head(10)
  
i213 %>%
    filter(!is.na(age), !is.na(sex)) %>%
    mutate(age_group = cut(age,
                           breaks = c(0, 18, 25, 40, 60, Inf),
                           right = FALSE)) %>%
    count(sex, age_group) %>%
    pivot_wider(names_from = sex, values_from = n)


i213 %>% 
  count(cmplxn, sort = TRUE)

```

## Age/Sex

```{r population_pyramid}

pop_data <- i213 %>%
    filter(!is.na(age), !is.na(sex), sex %in% c("M", "F")) %>%
    mutate(age_group = cut(age,
                           breaks = c(0, 18, 25, 40, 60, Inf),
                           right = FALSE),
           state = case_when(!state %in% c('WA', 'OR') ~ "ALL OTHERS",
                             TRUE ~ state)) %>%
    count(sex, age_group) %>%
    mutate(prop = n / sum(n)) %>%
    ungroup() %>% 
    mutate(n = case_when(sex == "F" ~ -n,
           TRUE ~ n),
           prop = case_when(sex == "F" ~ -prop,
           TRUE ~ prop))

pop_prop_range <- range(pop_data$prop)
pop_prop_range_breaks <- pretty(pop_prop_range, 10)

p1 <- pop_data %>% 
    ggplot(aes(x = prop, y = age_group, fill=sex)) +
    geom_col() +
    scale_y_discrete(limits=rev) +
    scale_x_continuous(breaks = pop_prop_range_breaks,
                       labels = function(x) scales::percent(abs(x))) +
  labs(title = "I-213 forms age/sex distribution")

p1

```

```{r pop_pyramid_lawsuit, warning=FALSE, message=FALSE}

pop_data <- i213 %>%
    filter(!is.na(age), !is.na(sex), sex %in% c("M", "F")) %>%
    mutate(age_group = cut(age,
                           breaks = c(0, 18, 25, 40, 60, Inf),
                           right = FALSE)) %>%
    group_by(sex, age_group, lawsuit) %>% 
    summarize(n = n()) %>% 
    group_by(lawsuit) %>% 
    mutate(prop = n / sum(n)) %>%
    ungroup() %>% 
    mutate(n = case_when(sex == "F" ~ -n,
           TRUE ~ n),
           prop = case_when(sex == "F" ~ -prop,
           TRUE ~ prop))

pop_prop_range <- range(pop_data$prop)
pop_prop_range_breaks <- pretty(pop_prop_range, 10)

p1 <- pop_data %>% 
    ggplot(aes(x = prop, y = age_group, fill=sex)) +
    geom_col() +
    scale_y_discrete(limits=rev) +
    scale_x_continuous(breaks = pop_prop_range_breaks,
                       labels = function(x) scales::percent(abs(x))) + 
  facet_wrap(~lawsuit) +
  labs(title = "I-213 forms age/sex distribution",
       subtitle = "Subsets by lawsuit production")

p1

```

## Country ranking

```{r country_rank}

my_theme <- function() {
  # Colors
  color.background = "white"
  color.text = "#22211d"
  # Begin construction of chart
  theme_bw(base_size=16) +
    # Format background colors
    theme(panel.background = element_rect(fill=color.background, color=color.background)) +
    theme(plot.background  = element_rect(fill=color.background, color=color.background)) +
    theme(panel.border     = element_rect(color=color.background)) +
    theme(strip.background = element_rect(fill=color.background, color=color.background)) +
    # Format the grid
    theme(panel.grid.major.y = element_blank()) +
    theme(panel.grid.minor.y = element_blank()) +
    theme(axis.ticks       = element_blank()) +
    # Format the legend
    theme(legend.position = "none") +
    # Format title and axis labels
    theme(plot.title       = element_text(color=color.text, size=20, face = "bold")) +
    theme(axis.title.x     = element_text(size=14, color="black", face = "bold")) +
    theme(axis.title.y     = element_text(size=14, color="black", face = "bold", vjust=1.25)) +
    theme(axis.text.x      = element_text(size=10, vjust=0.5, hjust=0, color = color.text)) +
    theme(axis.text.y      = element_text(size=10, color = color.text)) +
    theme(strip.text       = element_text(face = "bold")) +
    # Plot margins
    theme(plot.margin = unit(c(0.35, 0.2, 0.3, 0.35), "cm"))
}

show.top.n <- 10

rankings <- i213 %>% 
  filter(date >= '2019-01-01',
         date <= '2021-12-31') %>%
  mutate(country = substr(country_of_citizenship, start = 1, stop = 3)) %>% 
  count(quarter, country) %>% 
  arrange(quarter, desc(n), country) %>% 
  group_by(quarter) %>% 
  mutate(ranking = row_number(),
         quarter = as.character(quarter))

rankings <- rankings %>%
  mutate(flag = ifelse(country %in% c("MEX", "BRA", "HON", "GUA", "NIC", "EL ", "VEN", "CUB"), TRUE, FALSE),
         country_col = if_else(flag == TRUE, country, "zzz"))

p1 <- rankings %>%
  ggplot(aes(x = quarter, y = ranking, group = country)) +
  geom_line(aes(color = country_col, alpha=1), linewidth = 2) +
  geom_point(aes(color = country_col, alpha=1), size = 4) +
  geom_point(color = "#FFFFFF", size = 1) +
  scale_y_reverse(breaks = 1:show.top.n) +
  geom_text(data = rankings %>% filter(quarter == '2019.2'),
            aes(label = country, x = 0) , hjust = 0, nudge_x=-.1, fontface = "bold", color = "#888888", size = 4) +
  geom_text(data = rankings %>% filter(quarter == '2022.1'),
            aes(label = country, x = 14) , hjust = 1.5, fontface = "bold", color = "#888888", size = 4) +
  coord_cartesian(ylim = c(show.top.n,1)) +
  theme(legend.position = "none") +
  labs(x = "Quarter",
       y = "Rank",
       title = "SEA AOR I-213s",
       subtitle = "Country of citizenship rank") +
  my_theme() +
  scale_color_manual(values = c("#F70020","#191A1A","#FB9701","#1A7D00","#072C8F", "yellow", 'purple', "lightblue", "grey"))

p1

```

## Apprehension location: "At/Near"

```{r at_near, message = FALSE, warning = FALSE}

i213 %>% count(at_near, sort = TRUE) %>% 
   filter(n >= 20)

i213 %>%
   count(state, sort = TRUE)

i213 %>% group_by(lawsuit) %>% summarize(missing_at_near = sum(is.na(at_near)))

rankings <- i213 %>% 
  filter(date >= '2019-01-01',
         date <= '2021-12-31') %>%
  count(quarter, at_near) %>% 
  arrange(quarter, desc(n), at_near) %>% 
  group_by(quarter) %>% 
  mutate(ranking = row_number(),
         quarter = as.character(quarter)) %>% 
  filter(ranking <= 5)

```

### Mapping apprehension location

```{r at_near_maps, message = FALSE, warning = FALSE}

world <- ne_countries(scale = "medium", returnclass = "sf")
states <- st_as_sf(map("state", crs = 4326, plot = FALSE, fill = TRUE))
states <- cbind(states, st_coordinates(st_point_on_surface(states)))
states$ID <- toTitleCase(as.character(states$ID))

pnw_coords <- coord_sf(xlim = c(-130, -112.5), ylim = c(41, 50), expand = FALSE, crs = 4326)

data_at_near <- i213 %>% 
  group_by(at_near, lon, lat, lawsuit) %>% 
  summarise(n = n()) %>% 
  na.omit()

data_at_near <- st_as_sf(data_at_near, coords = c("lon", "lat"),
                  crs = 4326, agr = "constant")

ggplot(data = world) +
    geom_sf() +
    geom_sf(data = states, fill = NA) +
    geom_sf(data = data_at_near, aes(size=n), shape = 21, fill = "red", alpha=.5) +
    pnw_coords +
    ggtitle('I-213 forms by "at_near" latitude/longitude')

```

### Apprehension location by DHS office

```{r loc_code, message = FALSE, warning = FALSE}

i213 %>% count(location_code, sort = TRUE) %>% 
   filter(n >= 20)

i213$office <- str_match(i213$location_code, "SEA|POO|BLW|SPW")

loc_codes <- i213 %>% 
  group_by(location_code) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>% 
  na.omit()

loc_codes_county <- i213 %>% 
  group_by(location_code) %>% 
  summarize(n_counties = n_distinct(county),
            n_state = n_distinct(state)) %>% 
  arrange(desc(n_counties)) %>% 
  na.omit()

top <- unlist(loc_codes[1:20, 'location_code'])

sites <- i213 %>% select(lon, lat, location_code, office) %>% 
  filter(location_code %in% top) %>%
  na.omit()

sites <- st_as_sf(sites, coords = c("lon", "lat"),
                   crs = 4326, agr = "constant")

sites <- cbind(sites, st_coordinates(sites))

# Exclude small number of records outside geographic bounds of Pacific Northwest
sites <- sites[sites$X < -110,]
sites <- sites[sites$X > -130,]
sites <- sites[sites$Y < 50,]
sites <- sites[sites$Y > 42,]

sites <- sites %>% 
  na.omit()

m1 <- ggplot() +
    geom_sf(data = world) +
    geom_sf(data = states, fill = NA) + 
    geom_jitter(data = sites, size = 2, shape = 23, width=.25, height=.25, aes(x = X, y = Y, fill = location_code)) +
    pnw_coords +
    ggtitle('I-213 forms by approx. "at_near" latitude/longitude')

m2 <- ggplot() +
    geom_sf(data = world) +
    geom_sf(data = states, fill = NA) + 
    geom_point(data = sites, size = 2, shape = 23, aes(x = X, y = Y, fill = office)) +
    geom_encircle(data = sites, aes(x = X, y = Y, group=office, col=office)) +
    pnw_coords +
    ggtitle('I-213 forms by "at_near" latitude/longitude')

m1

m2

```

## "Method of Location/Apprehension"

```{r method_location_apprehension_top_10, message = FALSE, warning = FALSE}

i213 %>%
  filter(!is.na(method_location_apprehension)) %>% 
  count(method_location_apprehension, sort = TRUE) %>% 
   head(10)

```

```{r method_location_apprehension, message=FALSE, warning=FALSE}

i213$date <- as.Date(i213$date)

data <- i213 %>%
  select(date, state, source, method_location_apprehension, method_short, method_verbose, method_int_border, kww_in_force, office, county) %>%
  filter(!is.na(state),
         date >= '2019-01-01' & date <= '2022-01-01',
         source == 'ice')

data$month <- as.Date(cut(data$date, breaks='month'))

p1 <- data %>% 
  ggplot(aes(x = month)) +
  geom_bar() +
  # scale_x_date(labels = scales::date_format("%b"),
  #              breaks = "1 month") +
  facet_wrap(~method_short) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "I-213 Method of location/apprehension dist.")

p1

# p2 <- data %>%
#   ggplot(aes(x = method_short)) +
#   geom_bar(aes(fill= method_short)) +
#   facet_wrap(~office) +
#   theme(axis.text.x = element_text(angle = 90,
#                                    vjust = 0.5,
#                                    hjust = 1))
# 
# p2

priority_counties <- read_yaml('../../shared/hand/priority_counties.yaml')
priority_counties <- append(priority_counties, 'Whatcom County')

p3 <- data %>% 
  filter(county %in% priority_counties) %>% 
  ggplot(aes(x = county, fill= method_verbose)) +
  geom_bar(position = "fill") +
  scale_y_continuous() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))  +
  labs(title = "I-213 Method of location/apprehension prop.",
       subtitle = "WA priority counties")

p3

# p4 <- data %>% 
#   filter(!county %in% priority_counties) %>%
#   ggplot(aes(x = county, fill= method_verbose)) +
#   geom_bar(position = "fill") +
#   scale_y_continuous() +
#   theme(axis.text.x = element_text(angle = 90,
#                                    vjust = 0.5,
#                                    hjust = 1))
# 
# p4

# p5 <- data %>% 
#   filter(county %in% priority_counties) %>%
#   ggplot(aes(x = county, fill= method_int_border)) +
#   geom_bar() +
#   theme(axis.text.x = element_text(angle = 90,
#                                    vjust = 0.5,
#                                    hjust = 1)) +
#   labs(main= "I-213 Method of location/apprehension dist.")
# 
# p5

```


```{r method_lawsuit_compare}

p1 <- i213 %>% 
  filter(source == 'ice') %>% 
  count(lawsuit, method_short) %>% 
  ggplot(aes(x = method_short, y=n, fill=method_short)) +
  geom_col() +
  facet_wrap(~lawsuit)  +
  labs(title = "I-213 Method of location/apprehension dist.",
       subtitle = "Comparison of lawusit productions")
  
p1

```

### OR

```{r method_location_apprehension_or, message = FALSE, warning = FALSE}

data <- i213 %>%
  select(date, state, source, method_location_apprehension, method_short, method_verbose, kww_in_force, office, county) %>%
  filter(!is.na(state),
         date >= '2019-01-01',
         date <= '2021-12-31',
         source == 'ice')

data$month <- as.Date(cut(data$date, breaks='month'))

p1 <- data %>% 
  filter(!is.na(state),
         state == 'OR') %>% 
  ggplot(aes(x = month)) +
  geom_bar() +
  scale_x_date(labels = scales::date_format("%b"),
               breaks = "1 month") +
  facet_wrap(~method_short) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "OR I-213 forms by method of location/apprehension")

p1

p3 <- data %>%
    filter(!is.na(state),
         state == 'OR') %>% 
  ggplot(aes(x = county, fill= method_verbose)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "OR I-213 forms by county, method of location/apprehension")


p3

p5 <- data %>%
    filter(!is.na(state),
         state == 'OR') %>% 
  ggplot(aes(x = county, fill= method_verbose)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "OR I-213 forms by county, proportion method of location/apprehension")

p5

p4 <- data %>%
  filter(!is.na(state),
           state %in% c("OR", "WA")) %>% 
  ggplot(aes(x = state, fill= method_verbose)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "OR I-213 forms by method of location/apprehension")


p4

p6 <- data %>%
    filter(!is.na(state),
           state %in% c("OR", "WA")) %>% 
  ggplot(aes(x = state, fill= method_verbose)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  labs(title = "I-213 forms by proportion method of location/apprehension",
       subtitle = "WA/OR comparison")

p6


p7 <- data %>%
    filter(!is.na(state),
         state == 'OR') %>% 
  group_by(month, method_verbose) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = month, y=n, fill= method_verbose)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  facet_wrap(~method_verbose) +
  labs(title = "OR I-213 forms by method of location/apprehension")

p7

p8 <- data %>%
    filter(!is.na(state),
         state == 'WA') %>% 
  group_by(month, method_verbose) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = month, y=n, fill= method_verbose)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1)) +
  facet_wrap(~method_verbose) +
  labs(title = "WA I-213 forms by method of location/apprehension")

p8

```

### Country of origin

A few views of most common "Country of Origin" categories.

```{r country_by_loc_meth, message=FALSE, warning=FALSE}

top <- i213 %>% 
  filter(!is.na(country_of_citizenship)) %>% 
  count(country_of_citizenship, sort = TRUE)

top <- head(as.character(top$country_of_citizenship), 10)

i213 <- i213 %>% 
  filter(!is.na(country_of_citizenship)) %>% 
  mutate(country_short = case_when(country_of_citizenship %in% top ~ country_of_citizenship,
         TRUE ~ "ALL OTHERS"))

p1 <- i213 %>%
  ggplot(aes(x = country_short, fill= country_short)) +
  geom_bar() +
  facet_wrap(~office) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))

p1

p2 <- i213 %>%
  ggplot(aes(x = method_short, fill= method_short)) +
  geom_bar() +
  facet_wrap(~country_short) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))

p2

i213$month <- as.Date(cut(i213$date, breaks='month'))

p4 <- i213 %>% 
  filter(!is.na(state),
       state %in% c('WA','OR'),
       date >= '2019-01-01',
       date <= '2022-01-01',
       source == 'ice') %>% 
  count(month, state, country_short) %>% 
  ggplot(aes(x = month, y = n, fill=country_short)) +
  geom_col() +
  facet_wrap(~state) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5,
                                   hjust = 1))

p4

```

## `imm_record` and `crim_record`

```{r imm_record, message=FALSE, warning=FALSE}

i213 <- i213 %>% 
  mutate(imm_record = case_when(str_detect(imm_record, "NEGATIVE") ~ "NEGATIVE",
                                str_detect(imm_record, "NBGATIVB") ~ "NEGATIVE",
                                str_detect(imm_record, "POSITIVE") ~ "POSITIVE",
                                TRUE ~ NA_character_))

i213 %>%
  count(lawsuit,imm_record) %>% 
  arrange(desc(n))

i213 %>%
  filter(state %in% c('WA', 'OR')) %>% 
  count(state,imm_record) %>% 
  arrange(desc(n))

i213 %>%
  filter(date >= '2019-01-01',
         date <= '2021-12-31') %>% 
  count(imm_record, quarter) %>% 
  ggplot(aes(x=as.factor(quarter), y=n, fill=imm_record)) +
  geom_col()

i213 %>%
  filter(date >= '2019-01-01',
         date <= '2021-12-31') %>% 
  count(imm_record, office, quarter) %>% 
  ggplot(aes(x=as.factor(quarter), y=n, fill=imm_record)) +
  geom_col() +
  facet_wrap(~office)

i213 %>%
  filter(date >= '2019-01-01',
         date <= '2021-12-31',
         state %in% c('WA', 'OR') | is.na(state)) %>% 
  count(imm_record, state, quarter) %>% 
  ggplot(aes(x=as.factor(quarter), y=n, fill=imm_record)) +
  geom_col() +
  facet_wrap(~state)

i213 %>%
  count(imm_record, method_short) %>% 
  ggplot(aes(x=as.factor(method_short), y=n, fill=imm_record)) +
  geom_col()

# i213 %>%
#   filter(date >= '2019-01-01',
#          date <= '2021-12-31',
#          state %in% c('WA', 'OR'),
#          !is.na(imm_record),
#          !is.na(method_short)) %>% 
#   count(imm_record, state, method_short, quarter) %>% 
#   ggplot(aes(x=as.factor(quarter), y=n, fill=imm_record)) +
#   geom_col(position='fill') +
#   facet_grid(method_short ~ state)

```

```{r crim_record, message=FALSE, warning=FALSE}

i213 <- i213 %>% 
  mutate(crim_record = case_when(str_detect(crim_record, "See Narrative") ~ "See Narrative",
                                str_detect(crim_record, "None Known") ~ "None Known",
                                TRUE ~ NA_character_))

i213 %>%
  count(lawsuit,crim_record) %>% 
  arrange(desc(n))

i213 %>%
  filter(state %in% c('WA', 'OR')) %>% 
  count(state,crim_record) %>% 
  arrange(desc(n))

i213 %>%
  count(crim_record, method_short) %>% 
  ggplot(aes(x=as.factor(method_short), y=n, fill=crim_record)) +
  geom_col()

i213 %>%
  filter(date >= '2019-01-01',
         date <= '2021-12-31',
         state %in% c('WA', 'OR'),
         !is.na(crim_record),
         !is.na(method_short)) %>% 
  count(crim_record, state, method_short, quarter) %>% 
  ggplot(aes(x=as.factor(quarter), y=n, fill=crim_record)) +
  geom_col(position='fill') +
  facet_grid(method_short ~ state)

i213 %>%
  filter(date >= '2019-01-01',
         date <= '2021-12-31') %>% 
  count(crim_record, office, method_short) %>% 
  ggplot(aes(x=n, y=method_short, fill=crim_record)) +
  geom_col() +
  facet_grid(~ office)

i213 %>%
  count(crim_record, imm_record) %>% 
  ggplot(aes(x=crim_record, y=n, fill=imm_record)) +
  geom_col(position='fill')

```
